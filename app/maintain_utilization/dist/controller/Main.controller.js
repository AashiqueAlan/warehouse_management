sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,o,s,n,i){"use strict";return e.extend("maintainutilization.controller.Main",{onInit:function(){const e=new t({rows:[],originalRows:[],deletedRows:[],deletedContexts:{},queues:[],shifts:[],resources:[],editMode:false,toggleeditbtn:true,canAddRow:true,warehouseDisplay:""});this.getView().setModel(e,"ViewModel");this.getOwnerComponent().getRouter().getRoute("Main").attachPatternMatched(this._onRouteMatched,this)},onNavBack:function(){this.getOwnerComponent().getRouter().navTo("RouteDefault")},_loadInitialProcessors:function(e){const t=this.getOwnerComponent().getModel();const o=this.getView().getModel("ViewModel");const s=t.bindList("/ReadWhsProcessor",null,null,[new n("WarehouseNumber",i.EQ,e)],{$expand:"NavWhseProcessors"});s.requestContexts(0,1).then(e=>{if(!e.length)return;const t=e[0].getObject().NavWhseProcessors||[];const s=t.map((e,t)=>({SNo:t+1,WhseNo:e.WarehouseNumber,Shift:e.Shift,Resource:e.Processor,Queue:"",UtilizationRate:0,__state:"NEW",__source:"BACKEND"}));o.setProperty("/rows",s);o.setProperty("/originalRows",[]);o.setProperty("/editMode",false);o.setProperty("/toggleeditbtn",true);o.setProperty("/canAddRow",true)})},_onRouteMatched:function(e){const t=e.getParameter("arguments").lgnum;this._currentWarehouse=t;const o=this.getView().getModel("ViewModel");o.setProperty("/warehouseDisplay",t);o.setProperty("/rows",[]);o.setProperty("/originalRows",[]);o.setProperty("/deletedRows",[]);o.setProperty("/deletedContexts",{});this._loadQueues(t);this._loadShifts(t);this._loadResources(t);this._loadWarehouseData(t)},_loadQueues:function(e){const t=this.getOwnerComponent().getModel();const s=this.getView().getModel("ViewModel");t.bindList("/Queues",null,null,[new n("Lgnum",i.EQ,e)]).requestContexts(0,Infinity).then(function(e){const t=e.map(function(e){return e.getObject()});s.setProperty("/queues",t);console.log("Queues loaded:",t.length)}).catch(function(e){console.error("Failed to load queues:",e);o.show("Failed to load queues.");s.setProperty("/queues",[])})},_loadShifts:function(e){const t=this.getOwnerComponent().getModel();const s=this.getView().getModel("ViewModel");t.bindList("/ShiftDayNumbers",null,null,[new n("WarehouseNumber",i.EQ,e)]).requestContexts(0,Infinity).then(function(e){const t=e.map(function(e){return e.getObject()});s.setProperty("/shifts",t);console.log("Shifts loaded:",t.length)}).catch(function(e){console.error("Failed to load shifts:",e);o.show("Failed to load shifts.");s.setProperty("/shifts",[])})},_loadResources:function(e){const t=this.getOwnerComponent().getModel();const s=this.getView().getModel("ViewModel");t.bindList("/Resources",null,null,[new n("WarehouseNumber",i.EQ,e)]).requestContexts(0,Infinity).then(function(e){const t=e.map(function(e){return e.getObject()});s.setProperty("/resources",t);console.log("Resources loaded:",t.length)}).catch(function(e){console.error("Failed to load resources:",e);o.show("Failed to load resources.");s.setProperty("/resources",[])})},_loadWarehouseData:function(e){const t=this.getOwnerComponent().getModel();const s=this.getView().getModel("ViewModel");t.bindList("/UtilizationRates",null,null,[new n("WhseNo",i.EQ,e)]).requestContexts(0,Infinity).then(t=>{if(t.length>0){const e=t.map((e,t)=>{const o=e.getObject();return{SNo:t+1,__rowKey:`${o.WhseNo}|${o.Shift}|${o.Resource}|${o.Queue}`,WhseNo:o.WhseNo,Shift:o.Shift,Resource:o.Resource,Queue:o.Queue,UtilizationRate:o.UtilizationRate,__state:"UNCHANGED",__source:"DB"}});s.setProperty("/rows",e);s.setProperty("/originalRows",e.map(e=>({__rowKey:e.__rowKey,origShift:e.Shift,origResource:e.Resource,origQueue:e.Queue,UtilizationRate:e.UtilizationRate})));s.setProperty("/editMode",false);s.setProperty("/toggleeditbtn",true);s.setProperty("/canAddRow",false)}else{this._loadInitialProcessors(e)}}).catch(e=>{console.error("Failed to load warehouse data",e);o.show("Failed to load warehouse data")})},onEditButtonPress:function(){const e=this.getView().getModel("ViewModel");e.setProperty("/editMode",true);e.setProperty("/toggleeditbtn",false);e.setProperty("/canAddRow",true)},onAddRow:function(){const e=this.getView().getModel("ViewModel");const t=e.getProperty("/rows");t.push({SNo:t.length+1,WhseNo:this._currentWarehouse,Shift:"",Resource:"",Queue:"",UtilizationRate:0,__state:"NEW",__source:"UI"});e.setProperty("/rows",t);e.setProperty("/editMode",true);e.setProperty("/toggleeditbtn",false)},onDeleteRow:function(e){const t=this.getView().getModel("ViewModel");const o=t.getProperty("/rows");const s=parseInt(e.getParameter("listItem").getBindingContext("ViewModel").getPath().split("/")[2],10);const n=o[s];if(n.__state==="UNCHANGED"){const e=t.getProperty("/deletedRows")||[];e.push(n);t.setProperty("/deletedRows",e)}o.splice(s,1);o.forEach(function(e,t){e.SNo=t+1});t.setProperty("/rows",o)},onSaveButtonPress:function(){const e=this.getView().getModel("ViewModel");const t=this.getOwnerComponent().getModel();const n=e.getProperty("/rows");const i=e.getProperty("/originalRows");const r=e.getProperty("/deletedRows")||[];const u=e.getProperty("/queues");const a=e.getProperty("/shifts");const l=e.getProperty("/resources");const c=this;for(var h=0;h<n.length;h++){if(!n[h].Shift||!n[h].Resource||!n[h].Queue||n[h].UtilizationRate===""||n[h].UtilizationRate===null||n[h].UtilizationRate===undefined){s.error("Please fill all fields in row "+(h+1));return}const e=a.some(function(e){return e.Timeint===n[h].Shift});if(!e){s.error("Shift '"+n[h].Shift+"' in row "+(h+1)+" is not valid.");return}if(n[h].__source==="UI"){const e=l.some(function(e){return e.Processor===n[h].Resource});if(!e){s.error("Resource '"+n[h].Resource+"' in row "+(h+1)+" is not available.");return}}const t=u.some(function(e){return e.Queue===n[h].Queue});if(!t){s.error("Queue '"+n[h].Queue+"' in row "+(h+1)+" is not available.");return}if(n[h].UtilizationRate<0||n[h].UtilizationRate>100){s.error("Utilization Rate in row "+(h+1)+" must be between 0 and 100.");return}}for(let e=0;e<n.length;e++){for(let t=e+1;t<n.length;t++){if(n[e].WhseNo===n[t].WhseNo&&n[e].Shift===n[t].Shift&&n[e].Resource===n[t].Resource&&n[e].Queue===n[t].Queue){s.error("Duplicate entry found.\n\nRow "+(e+1)+" and Row "+(t+1)+" have the same combination.");return}}}const d=n.some(function(e){return e.__state==="NEW"});const g=r.length>0;const f=n.some(function(e){if(e.__state==="NEW")return false;const t=i.find(function(t){return t.__rowKey===e.__rowKey});if(t){return Number(e.UtilizationRate)!==Number(t.UtilizationRate)||e.Shift!==t.Shift||e.Resource!==t.Resource||e.Queue!==t.Queue}return false});if(!d&&!g&&!f){o.show("No changes detected");e.setProperty("/editMode",false);e.setProperty("/toggleeditbtn",true);e.setProperty("/canAddRow",false);return}const w=[];r.forEach(function(e){const o=`/UtilizationRates(WhseNo='${e.WhseNo}',Shift='${e.Shift}',Resource='${e.Resource}',Queue='${encodeURIComponent(e.Queue)}')`;const s=t.bindContext(o).getBoundContext();const n=s.requestObject().then(function(){return s.delete("$auto")});w.push(n)});n.forEach(function(e){if(e.__state==="NEW"){const o=t.bindList("/UtilizationRates");const s=o.create({WhseNo:e.WhseNo,Shift:e.Shift,Resource:e.Resource,Queue:e.Queue,UtilizationRate:Number(e.UtilizationRate)||0});w.push(s.created())}});n.forEach(function(e){if(e.__state==="UNCHANGED"){const o=i.find(function(t){return t.__rowKey===e.__rowKey});if(o){const s=Number(e.UtilizationRate)!==Number(o.UtilizationRate)||e.Shift!==o.Shift||e.Resource!==o.Resource||e.Queue!==o.Queue;if(s){const s=`/UtilizationRates(WhseNo='${e.WhseNo}',Shift='${o.origShift}',Resource='${o.origResource}',Queue='${encodeURIComponent(o.origQueue)}')`;const n=t.bindContext(s).getBoundContext();const i=n.requestObject().then(function(){n.setProperty("Shift",e.Shift);n.setProperty("Resource",e.Resource);n.setProperty("Queue",e.Queue);n.setProperty("UtilizationRate",Number(e.UtilizationRate));return t.submitBatch("$auto")});w.push(i)}}}});Promise.all(w).then(function(){return t.submitBatch("$auto")}).then(function(){o.show("âœ… Saved successfully");e.setProperty("/editMode",false);e.setProperty("/toggleeditbtn",true);e.setProperty("/canAddRow",false);e.setProperty("/deletedRows",[]);c._loadWarehouseData(c._currentWarehouse)}).catch(function(e){console.error("Save error:",e);s.error("Save failed: "+(e.message||"Unknown error"))})},onShiftValueHelp:function(e){const s=this.getView().getModel("ViewModel");const n=s.getProperty("/shifts");const i=e.getSource();if(n.length===0){o.show("No shifts available.");return}this._oShiftInput=i;if(!this._oShiftDialog){const e=new sap.m.Table({mode:"SingleSelectMaster",growing:true,growingThreshold:20,columns:[new sap.m.Column({header:new sap.m.Text({text:"Shift"})})],items:{path:"/",template:new sap.m.ColumnListItem({type:"Active",cells:[new sap.m.Text({text:"{Timeint}"})]})}});const o=new sap.m.SearchField({width:"100%",placeholder:"Search Shift...",search:this.onShiftVHSearch.bind(this),liveChange:this.onShiftVHSearch.bind(this)});this._oShiftDialog=new sap.m.Dialog({title:"Select Shift",contentWidth:"600px",contentHeight:"500px",draggable:true,resizable:true,content:[o,e],endButton:new sap.m.Button({text:"Cancel",press:function(){this._oShiftDialog.close()}.bind(this)})});this._oShiftDialog.setModel(new t(n));this.getView().addDependent(this._oShiftDialog);this._oShiftTable=e}else{this._oShiftDialog.getModel().setData(n)}this._oShiftTable.getBinding("items").filter([]);this._oShiftTable.removeSelections(true);this._oShiftTable.detachSelectionChange(this.onShiftRowSelect,this);this._oShiftTable.attachSelectionChange(this.onShiftRowSelect,this);this._oShiftDialog.open()},onShiftRowSelect:function(e){const t=e.getParameter("listItem");if(!t){return}const o=t.getBindingContext();const s=o.getObject();const n=s.Timeint;const i=this._oShiftInput.getBindingContext("ViewModel");const r=this.getView().getModel("ViewModel");r.setProperty(i.getPath()+"/Shift",n);this._oShiftDialog.close()},onShiftVHSearch:function(e){const t=e.getParameter("value")||e.getParameter("newValue")||"";const o=[];if(t){o.push(new n({filters:[new n("Timeint",i.Contains,t),,],and:false}))}this._oShiftTable.getBinding("items").filter(o)},onResourceValueHelp:function(e){const s=this.getView().getModel("ViewModel");const n=s.getProperty("/resources");const i=e.getSource();if(n.length===0){o.show("No resources available.");return}this._oResourceInput=i;if(!this._oResourceDialog){const e=new sap.m.Table({mode:"SingleSelectMaster",growing:true,growingThreshold:20,columns:[new sap.m.Column({header:new sap.m.Text({text:"Resource"})}),new sap.m.Column({header:new sap.m.Text({text:"Name"})})],items:{path:"/",template:new sap.m.ColumnListItem({type:"Active",cells:[new sap.m.Text({text:"{Processor}"}),new sap.m.Text({text:"{FullName}"})]})}});const o=new sap.m.SearchField({width:"100%",placeholder:"Search Resource...",search:this.onResourceVHSearch.bind(this),liveChange:this.onResourceVHSearch.bind(this)});this._oResourceDialog=new sap.m.Dialog({title:"Select Resource",contentWidth:"600px",contentHeight:"500px",draggable:true,resizable:true,content:[o,e],endButton:new sap.m.Button({text:"Cancel",press:function(){this._oResourceDialog.close()}.bind(this)})});this._oResourceDialog.setModel(new t(n));this.getView().addDependent(this._oResourceDialog);this._oResourceTable=e}else{this._oResourceDialog.getModel().setData(n)}this._oResourceTable.getBinding("items").filter([]);this._oResourceTable.removeSelections(true);this._oResourceTable.detachSelectionChange(this.onResourceRowSelect,this);this._oResourceTable.attachSelectionChange(this.onResourceRowSelect,this);this._oResourceDialog.open()},onResourceRowSelect:function(e){const t=e.getParameter("listItem");if(!t){return}const o=t.getBindingContext();const s=o.getObject();const n=s.Processor;const i=this._oResourceInput.getBindingContext("ViewModel");const r=this.getView().getModel("ViewModel");r.setProperty(i.getPath()+"/Resource",n);this._oResourceDialog.close()},onResourceVHSearch:function(e){const t=e.getParameter("value")||e.getParameter("newValue")||"";const o=[];if(t){o.push(new n({filters:[new n("Processor",i.Contains,t),new n("FullName",i.Contains,t)],and:false}))}this._oResourceTable.getBinding("items").filter(o)},onQueueValueHelp:function(e){const s=this.getView().getModel("ViewModel");const n=s.getProperty("/queues");const i=e.getSource();if(n.length===0){o.show("No queues available.");return}this._oQueueInput=i;if(!this._oQueueDialog){const e=new sap.m.Table({mode:"SingleSelectMaster",growing:true,growingThreshold:20,columns:[new sap.m.Column({header:new sap.m.Text({text:"Queue"})}),new sap.m.Column({header:new sap.m.Text({text:"Description"})})],items:{path:"/",template:new sap.m.ColumnListItem({type:"Active",cells:[new sap.m.Text({text:"{Queue}"}),new sap.m.Text({text:"{Text}"})]})}});const o=new sap.m.SearchField({width:"100%",placeholder:"Search Queue...",search:this.onQueueVHSearch.bind(this),liveChange:this.onQueueVHSearch.bind(this)});this._oQueueDialog=new sap.m.Dialog({title:"Select Queue",contentWidth:"600px",contentHeight:"500px",draggable:true,resizable:true,content:[o,e],endButton:new sap.m.Button({text:"Cancel",press:function(){this._oQueueDialog.close()}.bind(this)})});this._oQueueDialog.setModel(new t(n));this.getView().addDependent(this._oQueueDialog);this._oQueueTable=e}else{this._oQueueDialog.getModel().setData(n)}this._oQueueTable.getBinding("items").filter([]);this._oQueueTable.removeSelections(true);this._oQueueTable.detachSelectionChange(this.onQueueRowSelect,this);this._oQueueTable.attachSelectionChange(this.onQueueRowSelect,this);this._oQueueDialog.open()},onQueueRowSelect:function(e){const t=e.getParameter("listItem");if(!t){return}const o=t.getBindingContext();const s=o.getObject();const n=s.Queue;const i=this._oQueueInput.getBindingContext("ViewModel");const r=this.getView().getModel("ViewModel");r.setProperty(i.getPath()+"/Queue",n);this._oQueueDialog.close()},onQueueVHSearch:function(e){const t=e.getParameter("value")||e.getParameter("newValue")||"";const o=[];if(t){o.push(new n({filters:[new n("Queue",i.Contains,t),new n("Text",i.Contains,t)],and:false}))}this._oQueueTable.getBinding("items").filter(o)}})});
//# sourceMappingURL=Main.controller.js.map