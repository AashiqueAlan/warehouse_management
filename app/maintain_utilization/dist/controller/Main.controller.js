sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter"],function(e,t,o,i,n,s,r){"use strict";return e.extend("maintainutilization.controller.Main",{onInit:function(){const e=new t({rows:[],originalRows:[],deletedRows:[],deletedContexts:{},queues:[],shifts:[],resources:[],editMode:false,toggleeditbtn:true,canAddRow:true,warehouseDisplay:""});this.getView().setModel(e,"ViewModel");this.getOwnerComponent().getRouter().getRoute("Main").attachPatternMatched(this._onRouteMatched,this)},_onRouteMatched:function(e){const t=e.getParameter("arguments").lgnum;this._currentWarehouse=t;const o=this.getView().getModel("ViewModel");o.setProperty("/warehouseDisplay",t);o.setProperty("/rows",[]);o.setProperty("/originalRows",[]);o.setProperty("/deletedRows",[]);o.setProperty("/deletedContexts",{});this._loadQueues(t);this._loadShifts();this._loadResources(t);this._loadUtilizationRates(t)},_loadQueues:function(e){const t=this.getOwnerComponent().getModel();const i=this.getView().getModel("ViewModel");t.bindList("/Queues",null,null,[new n("Lgnum",s.EQ,e)]).requestContexts(0,Infinity).then(function(e){const t=e.map(function(e){return e.getObject()});i.setProperty("/queues",t);console.log("Queues loaded:",t.length)}).catch(function(e){console.error("Failed to load queues:",e);o.show("Failed to load queues.");i.setProperty("/queues",[])})},_loadShifts:function(){const e=this.getView().getModel("ViewModel");const t=[{Timeint:"MORNING",Timemodel:"Morning Shift"},{Timeint:"EVENING",Timemodel:"Evening Shift"}];e.setProperty("/shifts",t)},_loadResources:function(e){const t=this.getOwnerComponent().getModel();const i=this.getView().getModel("ViewModel");t.bindList("/Resources",null,null,[new n("Lgnum",s.EQ,e)]).requestContexts(0,Infinity).then(function(e){const t=e.map(function(e){return e.getObject()});i.setProperty("/resources",t);console.log("Resources loaded:",t.length)}).catch(function(e){console.error("Failed to load resources:",e);o.show("Failed to load resources.");i.setProperty("/resources",[])})},_loadUtilizationRates:function(e){const t=this.getOwnerComponent().getModel();const i=this.getView().getModel("ViewModel");t.bindList("/UtilizationRates",null,[new r("createdAt",false)],[new n("WhseNo",s.EQ,e)]).requestContexts(0,Infinity).then(function(t){const n=t.map(function(e,t){const o=e.getObject();return{SNo:t+1,WhseNo:o.WhseNo,Shift:o.Shift,Resource:o.Resource,Queue:o.Queue,UtilizationRate:o.UtilizationRate,createdAt:o.createdAt,__state:"UNCHANGED"}});i.setProperty("/rows",n);const s=n.map((e,t)=>({SNo:e.SNo,WhseNo:e.WhseNo,origShift:e.Shift,origResource:e.Resource,origQueue:e.Queue,Shift:e.Shift,Resource:e.Resource,Queue:e.Queue,UtilizationRate:e.UtilizationRate,createdAt:e.createdAt,__state:e.__state,origIndex:t}));i.setProperty("/originalRows",s);if(n.length===0){i.setProperty("/editMode",true);i.setProperty("/toggleeditbtn",false);i.setProperty("/canAddRow",true);o.show("No existing records found for warehouse "+e)}else{i.setProperty("/editMode",false);i.setProperty("/toggleeditbtn",true);i.setProperty("/canAddRow",false)}}).catch(function(e){console.error("Failed to load utilization rates",e);o.show("Failed to load data. You can add new rows.");i.setProperty("/rows",[]);i.setProperty("/originalRows",[]);i.setProperty("/editMode",true);i.setProperty("/toggleeditbtn",false)})},onEditButtonPress:function(){const e=this.getView().getModel("ViewModel");e.setProperty("/editMode",true);e.setProperty("/toggleeditbtn",false);e.setProperty("/canAddRow",true)},onAddRow:function(){const e=this.getView().getModel("ViewModel");const t=e.getProperty("/rows");t.push({SNo:t.length+1,WhseNo:this._currentWarehouse,Shift:"",Resource:"",Queue:"",UtilizationRate:0,__state:"NEW"});e.setProperty("/rows",t);e.setProperty("/editMode",true);e.setProperty("/toggleeditbtn",false)},onDeleteRow:function(e){const t=this.getView().getModel("ViewModel");const o=t.getProperty("/rows");const i=parseInt(e.getParameter("listItem").getBindingContext("ViewModel").getPath().split("/")[2],10);const n=o[i];if(n.__state==="UNCHANGED"){const e=t.getProperty("/deletedRows")||[];e.push(n);t.setProperty("/deletedRows",e)}o.splice(i,1);o.forEach(function(e,t){e.SNo=t+1});t.setProperty("/rows",o)},onSaveButtonPress:function(){const e=this.getView().getModel("ViewModel");const t=this.getOwnerComponent().getModel();const n=e.getProperty("/rows");const s=e.getProperty("/originalRows");const r=e.getProperty("/deletedRows")||[];const a=e.getProperty("/queues");const u=e.getProperty("/shifts");const l=e.getProperty("/resources");const c=this;for(var h=0;h<n.length;h++){if(!n[h].Shift||!n[h].Resource||!n[h].Queue||n[h].UtilizationRate===""||n[h].UtilizationRate===null||n[h].UtilizationRate===undefined){i.error("Please fill all fields in row "+(h+1));return}const e=u.some(function(e){return e.Timeint===n[h].Shift});if(!e){i.error("Shift '"+n[h].Shift+"' in row "+(h+1)+" is not valid.");return}const t=l.some(function(e){return e.Rsrc===n[h].Resource});if(!t){i.error("Resource '"+n[h].Resource+"' in row "+(h+1)+" is not available.");return}const o=a.some(function(e){return e.Queue===n[h].Queue});if(!o){i.error("Queue '"+n[h].Queue+"' in row "+(h+1)+" is not available.");return}if(n[h].UtilizationRate<0||n[h].UtilizationRate>100){i.error("Utilization Rate in row "+(h+1)+" must be between 0 and 100.");return}}for(let e=0;e<n.length;e++){for(let t=e+1;t<n.length;t++){if(n[e].WhseNo===n[t].WhseNo&&n[e].Shift===n[t].Shift&&n[e].Resource===n[t].Resource&&n[e].Queue===n[t].Queue){i.error("Duplicate entry found.\n\nRow "+(e+1)+" and Row "+(t+1)+" have the same combination.");return}}}const d=n.some(function(e){return e.__state==="NEW"});const g=r.length>0;const f=n.some(function(e,t){const o=s.find(function(e){return e.origIndex===t});if(o){return Number(e.UtilizationRate)!==Number(o.UtilizationRate)||e.Shift!==o.Shift||e.Resource!==o.Resource||e.Queue!==o.Queue}return false});if(!d&&!g&&!f){o.show("No changes detected");e.setProperty("/editMode",false);e.setProperty("/toggleeditbtn",true);e.setProperty("/canAddRow",false);return}const w=[];r.forEach(function(e){const o=`/UtilizationRates(WhseNo='${e.WhseNo}',Shift='${e.Shift}',Resource='${e.Resource}',Queue='${encodeURIComponent(e.Queue)}')`;const i=t.bindContext(o).getBoundContext();const n=i.requestObject().then(function(){return i.delete("$auto")});w.push(n)});n.forEach(function(e){if(e.__state==="NEW"){const o=t.bindList("/UtilizationRates");const i=o.create({WhseNo:e.WhseNo,Shift:e.Shift,Resource:e.Resource,Queue:e.Queue,UtilizationRate:Number(e.UtilizationRate)||0});w.push(i.created())}});n.forEach(function(e,o){if(e.__state==="UNCHANGED"){const i=s.find(function(e){return e.origIndex===o});if(i){const o=Number(e.UtilizationRate)!==Number(i.UtilizationRate)||e.Shift!==i.Shift||e.Resource!==i.Resource||e.Queue!==i.Queue;if(o){const o=`/UtilizationRates(WhseNo='${e.WhseNo}',Shift='${i.origShift}',Resource='${i.origResource}',Queue='${encodeURIComponent(i.origQueue)}')`;const n=t.bindContext(o).getBoundContext();const s=n.requestObject().then(function(){n.setProperty("Shift",e.Shift);n.setProperty("Resource",e.Resource);n.setProperty("Queue",e.Queue);n.setProperty("UtilizationRate",Number(e.UtilizationRate));return t.submitBatch("$auto")});w.push(s)}}}});Promise.all(w).then(function(){return t.submitBatch("$auto")}).then(function(){o.show("âœ… Saved successfully");e.setProperty("/editMode",false);e.setProperty("/toggleeditbtn",true);e.setProperty("/canAddRow",false);e.setProperty("/deletedRows",[]);c._loadUtilizationRates(c._currentWarehouse)}).catch(function(e){console.error("Save error:",e);i.error("Save failed: "+(e.message||"Unknown error"))})},onShiftValueHelp:function(e){const i=this.getView().getModel("ViewModel");const n=i.getProperty("/shifts");const s=e.getSource();if(n.length===0){o.show("No shifts available.");return}this._oShiftInput=s;if(!this._oShiftDialog){const e=new sap.m.Table({mode:"SingleSelectMaster",growing:true,growingThreshold:20,columns:[new sap.m.Column({header:new sap.m.Text({text:"Shift"})}),new sap.m.Column({header:new sap.m.Text({text:"Time Model"})})],items:{path:"/",template:new sap.m.ColumnListItem({type:"Active",cells:[new sap.m.Text({text:"{Timeint}"}),new sap.m.Text({text:"{Timemodel}"})]})}});const o=new sap.m.SearchField({width:"100%",placeholder:"Search Shift...",search:this.onShiftVHSearch.bind(this),liveChange:this.onShiftVHSearch.bind(this)});this._oShiftDialog=new sap.m.Dialog({title:"Select Shift",contentWidth:"600px",contentHeight:"500px",draggable:true,resizable:true,content:[o,e],endButton:new sap.m.Button({text:"Cancel",press:function(){this._oShiftDialog.close()}.bind(this)})});this._oShiftDialog.setModel(new t(n));this.getView().addDependent(this._oShiftDialog);this._oShiftTable=e}else{this._oShiftDialog.getModel().setData(n)}this._oShiftTable.getBinding("items").filter([]);this._oShiftTable.removeSelections(true);this._oShiftTable.detachSelectionChange(this.onShiftRowSelect,this);this._oShiftTable.attachSelectionChange(this.onShiftRowSelect,this);this._oShiftDialog.open()},onShiftRowSelect:function(e){const t=e.getParameter("listItem");if(!t){return}const o=t.getBindingContext();const i=o.getObject();const n=i.Timeint;const s=this._oShiftInput.getBindingContext("ViewModel");const r=this.getView().getModel("ViewModel");r.setProperty(s.getPath()+"/Shift",n);this._oShiftDialog.close()},onShiftVHSearch:function(e){const t=e.getParameter("value")||e.getParameter("newValue")||"";const o=[];if(t){o.push(new n({filters:[new n("Timeint",s.Contains,t),new n("Timemodel",s.Contains,t)],and:false}))}this._oShiftTable.getBinding("items").filter(o)},onResourceValueHelp:function(e){const i=this.getView().getModel("ViewModel");const n=i.getProperty("/resources");const s=e.getSource();if(n.length===0){o.show("No resources available.");return}this._oResourceInput=s;if(!this._oResourceDialog){const e=new sap.m.Table({mode:"SingleSelectMaster",growing:true,growingThreshold:20,columns:[new sap.m.Column({header:new sap.m.Text({text:"Resource"})}),new sap.m.Column({header:new sap.m.Text({text:"Type"})})],items:{path:"/",template:new sap.m.ColumnListItem({type:"Active",cells:[new sap.m.Text({text:"{Rsrc}"}),new sap.m.Text({text:"{RsrcType}"})]})}});const o=new sap.m.SearchField({width:"100%",placeholder:"Search Resource...",search:this.onResourceVHSearch.bind(this),liveChange:this.onResourceVHSearch.bind(this)});this._oResourceDialog=new sap.m.Dialog({title:"Select Resource",contentWidth:"600px",contentHeight:"500px",draggable:true,resizable:true,content:[o,e],endButton:new sap.m.Button({text:"Cancel",press:function(){this._oResourceDialog.close()}.bind(this)})});this._oResourceDialog.setModel(new t(n));this.getView().addDependent(this._oResourceDialog);this._oResourceTable=e}else{this._oResourceDialog.getModel().setData(n)}this._oResourceTable.getBinding("items").filter([]);this._oResourceTable.removeSelections(true);this._oResourceTable.detachSelectionChange(this.onResourceRowSelect,this);this._oResourceTable.attachSelectionChange(this.onResourceRowSelect,this);this._oResourceDialog.open()},onResourceRowSelect:function(e){const t=e.getParameter("listItem");if(!t){return}const o=t.getBindingContext();const i=o.getObject();const n=i.Rsrc;const s=this._oResourceInput.getBindingContext("ViewModel");const r=this.getView().getModel("ViewModel");r.setProperty(s.getPath()+"/Resource",n);this._oResourceDialog.close()},onResourceVHSearch:function(e){const t=e.getParameter("value")||e.getParameter("newValue")||"";const o=[];if(t){o.push(new n({filters:[new n("Rsrc",s.Contains,t),new n("RsrcType",s.Contains,t)],and:false}))}this._oResourceTable.getBinding("items").filter(o)},onQueueValueHelp:function(e){const i=this.getView().getModel("ViewModel");const n=i.getProperty("/queues");const s=e.getSource();if(n.length===0){o.show("No queues available.");return}this._oQueueInput=s;if(!this._oQueueDialog){const e=new sap.m.Table({mode:"SingleSelectMaster",growing:true,growingThreshold:20,columns:[new sap.m.Column({header:new sap.m.Text({text:"Queue"})}),new sap.m.Column({header:new sap.m.Text({text:"Description"})})],items:{path:"/",template:new sap.m.ColumnListItem({type:"Active",cells:[new sap.m.Text({text:"{Queue}"}),new sap.m.Text({text:"{Text}"})]})}});const o=new sap.m.SearchField({width:"100%",placeholder:"Search Queue...",search:this.onQueueVHSearch.bind(this),liveChange:this.onQueueVHSearch.bind(this)});this._oQueueDialog=new sap.m.Dialog({title:"Select Queue",contentWidth:"600px",contentHeight:"500px",draggable:true,resizable:true,content:[o,e],endButton:new sap.m.Button({text:"Cancel",press:function(){this._oQueueDialog.close()}.bind(this)})});this._oQueueDialog.setModel(new t(n));this.getView().addDependent(this._oQueueDialog);this._oQueueTable=e}else{this._oQueueDialog.getModel().setData(n)}this._oQueueTable.getBinding("items").filter([]);this._oQueueTable.removeSelections(true);this._oQueueTable.detachSelectionChange(this.onQueueRowSelect,this);this._oQueueTable.attachSelectionChange(this.onQueueRowSelect,this);this._oQueueDialog.open()},onQueueRowSelect:function(e){const t=e.getParameter("listItem");if(!t){return}const o=t.getBindingContext();const i=o.getObject();const n=i.Queue;const s=this._oQueueInput.getBindingContext("ViewModel");const r=this.getView().getModel("ViewModel");r.setProperty(s.getPath()+"/Queue",n);this._oQueueDialog.close()},onQueueVHSearch:function(e){const t=e.getParameter("value")||e.getParameter("newValue")||"";const o=[];if(t){o.push(new n({filters:[new n("Queue",s.Contains,t),new n("Text",s.Contains,t)],and:false}))}this._oQueueTable.getBinding("items").filter(o)}})});
//# sourceMappingURL=Main.controller.js.map