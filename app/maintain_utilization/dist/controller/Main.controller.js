sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,o,s,i,n){"use strict";return e.extend("maintainutilization.controller.Main",{onInit:function(){const e=new t({rows:[],originalRows:[],deletedRows:[],queues:[],shifts:[],resources:[],editMode:false,toggleeditbtn:true,canAddRow:true,warehouseDisplay:""});this.getView().setModel(e,"ViewModel");this.getOwnerComponent().getRouter().getRoute("Main").attachPatternMatched(this._onRouteMatched,this)},onNavBack:function(){this.getOwnerComponent().getRouter().navTo("RouteDefault")},_loadInitialProcessors:function(e){const t=this.getOwnerComponent().getModel();const o=this.getView().getModel("ViewModel");const s=t.bindList("/ReadWhsProcessor",null,null,[new i("WarehouseNumber",n.EQ,e)],{$expand:"NavWhseProcessors"});s.requestContexts(0,1).then(e=>{if(!e.length)return;const t=e[0].getObject().NavWhseProcessors||[];const s=t.map((e,t)=>({SNo:t+1,WhseNo:e.WarehouseNumber,Shift:e.Shift,Resource:e.Processor,Queue:"",UtilizationRate:0,__state:"NEW",__source:"FALLBACK"}));o.setProperty("/rows",s);o.setProperty("/originalRows",[]);o.setProperty("/editMode",false);o.setProperty("/toggleeditbtn",true);o.setProperty("/canAddRow",true)})},_onRouteMatched:function(e){const t=e.getParameter("arguments").lgnum;this._currentWarehouse=t;const o=this.getView().getModel("ViewModel");o.setProperty("/warehouseDisplay",t);o.setProperty("/queues",[]);o.setProperty("/shifts",[]);o.setProperty("/resources",[]);o.setProperty("/rows",[]);o.setProperty("/originalRows",[]);o.setProperty("/deletedRows",[]);this._loadWarehouseData(t)},_loadWarehouseData:function(e){const t=this.getOwnerComponent().getModel();const s=this.getView().getModel("ViewModel");t.bindList("/UtilizationRates",null,null,[new i("WhseNo",n.EQ,e)]).requestContexts(0,Infinity).then(t=>{if(t.length>0){const e=t.map((e,t)=>{const o=e.getObject();return{SNo:t+1,__rowKey:`${o.WhseNo}|${o.Shift}|${o.Resource}|${o.Queue}`,WhseNo:o.WhseNo,Shift:o.Shift,Resource:o.Resource,Queue:o.Queue,UtilizationRate:o.UtilizationRate,__state:"UNCHANGED",__source:"DB"}});s.setProperty("/rows",e);s.setProperty("/originalRows",e.map(e=>({__rowKey:e.__rowKey,origShift:e.Shift,origResource:e.Resource,origQueue:e.Queue,UtilizationRate:e.UtilizationRate})));s.setProperty("/editMode",false);s.setProperty("/toggleeditbtn",true);s.setProperty("/canAddRow",false)}else{this._loadInitialProcessors(e)}}).catch(e=>{console.error("Failed to load warehouse data",e);o.show("Failed to load warehouse data")})},onEditButtonPress:function(){const e=this.getView().getModel("ViewModel");e.setProperty("/editMode",true);e.setProperty("/toggleeditbtn",false);e.setProperty("/canAddRow",true)},onAddRow:function(){const e=this.getView().getModel("ViewModel");const t=e.getProperty("/rows");t.push({SNo:t.length+1,WhseNo:this._currentWarehouse,Shift:"",Resource:"",Queue:"",UtilizationRate:0,__state:"NEW",__source:"UI"});e.setProperty("/rows",t);e.setProperty("/editMode",true);e.setProperty("/toggleeditbtn",false)},onDeleteRow:function(e){const t=this.getView().getModel("ViewModel");const o=t.getProperty("/rows");const s=parseInt(e.getParameter("listItem").getBindingContext("ViewModel").getPath().split("/")[2],10);const i=o[s];if(i.__state==="UNCHANGED"){const e=t.getProperty("/deletedRows")||[];e.push(i);t.setProperty("/deletedRows",e)}o.splice(s,1);o.forEach(function(e,t){e.SNo=t+1});t.setProperty("/rows",o)},onSaveButtonPress:function(){const e=this.getView().getModel("ViewModel");const t=this.getOwnerComponent().getModel();const i=e.getProperty("/rows");const n=e.getProperty("/originalRows");const r=e.getProperty("/deletedRows")||[];const a=this;for(let e=0;e<i.length;e++){const t=i[e];if(!t.Shift||!t.Resource||!t.Queue||t.UtilizationRate==null||t.UtilizationRate===""){s.error("Please fill all fields in row "+(e+1));return}if(t.UtilizationRate<0||t.UtilizationRate>100){s.error("Utilization Rate must be between 0 and 100 (row "+(e+1)+")");return}}const u=i.some(e=>e.__state==="NEW");const l=r.length>0;const c=i.some(e=>{if(e.__state==="NEW")return false;const t=n.find(t=>t.__rowKey===e.__rowKey);return t&&Number(t.UtilizationRate)!==Number(e.UtilizationRate)});if(!u&&!l&&!c){o.show("No changes detected");e.setProperty("/editMode",false);e.setProperty("/toggleeditbtn",true);return}const h=[];r.forEach(e=>{const o="/UtilizationRates(WhseNo='"+e.WhseNo+"',Shift='"+e.Shift+"',Resource='"+e.Resource+"',Queue='"+encodeURIComponent(e.Queue)+"')";const s=t.bindContext(o).getBoundContext();h.push(s.requestObject().then(()=>s.delete("$auto")))});i.forEach(e=>{if(e.__state==="NEW"){const o=e.__source!=="UI"&&n.some(t=>t.origShift===e.Shift&&t.origResource===e.Resource&&t.origQueue===e.Queue);if(o){const o="/UtilizationRates(WhseNo='"+e.WhseNo+"',Shift='"+e.Shift+"',Resource='"+e.Resource+"',Queue='"+encodeURIComponent(e.Queue)+"')";const s=t.bindContext(o).getBoundContext();s.setProperty("UtilizationRate",Number(e.UtilizationRate));return}const s=t.bindList("/UtilizationRates");const i=s.create({WhseNo:e.WhseNo,Shift:e.Shift,Resource:e.Resource,Queue:e.Queue,UtilizationRate:Number(e.UtilizationRate)});h.push(i.created())}});i.forEach(e=>{if(e.__state==="UNCHANGED"){const o=n.find(t=>t.__rowKey===e.__rowKey);if(o&&Number(o.UtilizationRate)!==Number(e.UtilizationRate)){const s="/UtilizationRates(WhseNo='"+e.WhseNo+"',Shift='"+o.origShift+"',Resource='"+o.origResource+"',Queue='"+encodeURIComponent(o.origQueue)+"')";const i=t.bindContext(s).getBoundContext();i.setProperty("UtilizationRate",Number(e.UtilizationRate))}}});Promise.all(h).then(()=>t.submitBatch("$auto")).then(()=>{o.show("âœ… Saved successfully");e.setProperty("/editMode",false);e.setProperty("/toggleeditbtn",true);e.setProperty("/canAddRow",false);e.setProperty("/deletedRows",[]);a._loadWarehouseData(a._currentWarehouse)}).catch(()=>{s.error("Save failed")})},onShiftValueHelp:function(e){const t=this.getView().getModel("ViewModel");const s=this._currentWarehouse;this._oShiftInput=e.getSource();if(t.getProperty("/shifts").length>0){this._openShiftDialog();return}sap.ui.core.BusyIndicator.show(0);this.getOwnerComponent().getModel().bindList("/ShiftDayNumbers",null,null,[new i("WarehouseNumber",n.EQ,s)]).requestContexts(0,Infinity).then(e=>{t.setProperty("/shifts",e.map(e=>e.getObject()));this._openShiftDialog()}).catch(()=>{o.show("Failed to load Shifts")}).finally(()=>{sap.ui.core.BusyIndicator.hide()})},onShiftRowSelect:function(e){const t=e.getParameter("listItem");if(!t){return}const o=t.getBindingContext();const s=o.getObject();const i=s.Timeint;const n=this._oShiftInput.getBindingContext("ViewModel");const r=this.getView().getModel("ViewModel");r.setProperty(n.getPath()+"/Shift",i);this._oShiftDialog.close()},onShiftVHSearch:function(e){const t=e.getParameter("value")||e.getParameter("newValue")||"";const o=[];if(t){o.push(new i({filters:[new i("Timeint",n.Contains,t),,],and:false}))}this._oShiftTable.getBinding("items").filter(o)},onResourceValueHelp:function(e){const t=this.getView().getModel("ViewModel");const s=e.getSource();const r=this._currentWarehouse;this._oResourceInput=s;if(t.getProperty("/resources").length>0){this._openResourceDialog();return}sap.ui.core.BusyIndicator.show(0);const a=this.getOwnerComponent().getModel();a.bindList("/Resources",null,null,[new i("WarehouseNumber",n.EQ,r)]).requestContexts(0,Infinity).then(e=>{const o=e.map(e=>e.getObject());const s={};o.forEach(e=>{if(!s[e.Processor]){s[e.Processor]={Processor:e.Processor,FullName:e.FullName||""}}});t.setProperty("/resources",Object.values(s));this._openResourceDialog()}).catch(()=>{o.show("Failed to load resources")}).finally(()=>{sap.ui.core.BusyIndicator.hide()})},onResourceRowSelect:function(e){const t=e.getParameter("listItem");if(!t){return}const o=t.getBindingContext();const s=o.getObject();const i=s.Processor;const n=this._oResourceInput.getBindingContext("ViewModel");const r=this.getView().getModel("ViewModel");r.setProperty(n.getPath()+"/Resource",i);this._oResourceDialog.close()},onResourceVHSearch:function(e){const t=e.getParameter("value")||e.getParameter("newValue")||"";const o=[];if(t){o.push(new i({filters:[new i("Processor",n.Contains,t),new i("FullName",n.Contains,t)],and:false}))}this._oResourceTable.getBinding("items").filter(o)},onQueueValueHelp:function(e){const t=this.getView().getModel("ViewModel");const s=this._currentWarehouse;this._oQueueInput=e.getSource();if(t.getProperty("/queues").length>0){this._openQueueDialog();return}sap.ui.core.BusyIndicator.show(0);this.getOwnerComponent().getModel().bindList("/Queues",null,null,[new i("Lgnum",n.EQ,s)]).requestContexts(0,Infinity).then(e=>{t.setProperty("/queues",e.map(e=>e.getObject()));this._openQueueDialog()}).catch(()=>{o.show("Failed to load Queues")}).finally(()=>{sap.ui.core.BusyIndicator.hide()})},onQueueRowSelect:function(e){const t=e.getParameter("listItem");if(!t){return}const o=t.getBindingContext();const s=o.getObject();const i=s.Queue;const n=this._oQueueInput.getBindingContext("ViewModel");const r=this.getView().getModel("ViewModel");r.setProperty(n.getPath()+"/Queue",i);this._oQueueDialog.close()},onQueueVHSearch:function(e){const t=e.getParameter("value")||e.getParameter("newValue")||"";const o=[];if(t){o.push(new i({filters:[new i("Queue",n.Contains,t),new i("Text",n.Contains,t)],and:false}))}this._oQueueTable.getBinding("items").filter(o)},_openResourceDialog:function(){const e=this.getView().getModel("ViewModel");const o=e.getProperty("/resources");if(!this._oResourceDialog){const e=new sap.m.Table({mode:"SingleSelectMaster",growing:true,growingThreshold:20,columns:[new sap.m.Column({header:new sap.m.Text({text:"Resource"})}),new sap.m.Column({header:new sap.m.Text({text:"Name"})})],items:{path:"/",template:new sap.m.ColumnListItem({type:"Active",cells:[new sap.m.Text({text:"{Processor}"}),new sap.m.Text({text:"{FullName}"})]})}});const s=new sap.m.SearchField({width:"100%",placeholder:"Search Resource...",liveChange:this.onResourceVHSearch.bind(this),search:this.onResourceVHSearch.bind(this)});this._oResourceDialog=new sap.m.Dialog({title:"Select Resource",contentWidth:"600px",contentHeight:"500px",draggable:true,resizable:true,content:[s,e],endButton:new sap.m.Button({text:"Cancel",press:()=>this._oResourceDialog.close()})});this._oResourceDialog.setModel(new t(o));this.getView().addDependent(this._oResourceDialog);this._oResourceTable=e}else{this._oResourceDialog.getModel().setData(o)}this._oResourceTable.removeSelections(true);this._oResourceTable.getBinding("items").filter([]);this._oResourceTable.attachSelectionChange(this.onResourceRowSelect,this);this._oResourceDialog.open()},_openShiftDialog:function(){const e=this.getView().getModel("ViewModel");const o=e.getProperty("/shifts");if(!this._oShiftDialog){const e=new sap.m.Table({mode:"SingleSelectMaster",growing:true,columns:[new sap.m.Column({header:new sap.m.Text({text:"Shift"})})],items:{path:"/",template:new sap.m.ColumnListItem({type:"Active",cells:[new sap.m.Text({text:"{Timeint}"})]})}});const s=new sap.m.SearchField({width:"100%",placeholder:"Search Shift...",liveChange:this.onShiftVHSearch.bind(this),search:this.onShiftVHSearch.bind(this)});this._oShiftDialog=new sap.m.Dialog({title:"Select Shift",contentWidth:"600px",contentHeight:"500px",draggable:true,resizable:true,content:[s,e],endButton:new sap.m.Button({text:"Cancel",press:()=>this._oShiftDialog.close()})});this._oShiftDialog.setModel(new t(o));this.getView().addDependent(this._oShiftDialog);this._oShiftTable=e}else{this._oShiftDialog.getModel().setData(o)}this._oShiftTable.removeSelections(true);this._oShiftTable.getBinding("items").filter([]);this._oShiftTable.attachSelectionChange(this.onShiftRowSelect,this);this._oShiftDialog.open()},_openQueueDialog:function(){const e=this.getView().getModel("ViewModel");const o=e.getProperty("/queues");if(!this._oQueueDialog){const e=new sap.m.Table({mode:"SingleSelectMaster",growing:true,columns:[new sap.m.Column({header:new sap.m.Text({text:"Queue"})}),new sap.m.Column({header:new sap.m.Text({text:"Description"})})],items:{path:"/",template:new sap.m.ColumnListItem({type:"Active",cells:[new sap.m.Text({text:"{Queue}"}),new sap.m.Text({text:"{Text}"})]})}});const s=new sap.m.SearchField({width:"100%",placeholder:"Search Queue...",liveChange:this.onQueueVHSearch.bind(this),search:this.onQueueVHSearch.bind(this)});this._oQueueDialog=new sap.m.Dialog({title:"Select Queue",contentWidth:"600px",contentHeight:"500px",draggable:true,resizable:true,content:[s,e],endButton:new sap.m.Button({text:"Cancel",press:()=>this._oQueueDialog.close()})});this._oQueueDialog.setModel(new t(o));this.getView().addDependent(this._oQueueDialog);this._oQueueTable=e}else{this._oQueueDialog.getModel().setData(o)}this._oQueueTable.removeSelections(true);this._oQueueTable.getBinding("items").filter([]);this._oQueueTable.attachSelectionChange(this.onQueueRowSelect,this);this._oQueueDialog.open()}})});
//# sourceMappingURL=Main.controller.js.map