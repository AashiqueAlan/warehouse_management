sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter"],function(e,t,o,n,s,i,r){"use strict";return e.extend("warehousestandards.controller.Main",{onInit:function(){const e=new t({rows:[],originalRows:[],deletedRows:[],queues:[],uoms:[],editMode:false,toggleeditbtn:true,canAddRow:true,warehouseDisplay:""});this.getView().setModel(e,"ViewModel");this.getOwnerComponent().getRouter().getRoute("Main").attachPatternMatched(this._onRouteMatched,this)},onNavBack:function(){this.getOwnerComponent().getRouter().navTo("RouteDefault")},_onRouteMatched:function(e){const t=e.getParameter("arguments").lgnum;this._currentWarehouse=t;const o=this.getView().getModel("ViewModel");o.setProperty("/warehouseDisplay",t);o.setProperty("/rows",[]);o.setProperty("/originalRows",[]);o.setProperty("/deletedRows",[]);this._loadQueues(t);this._loadUoms();this._loadWarehouseStandards(t)},_loadQueues:function(e){const t=this.getOwnerComponent().getModel();const n=this.getView().getModel("ViewModel");t.bindList("/Queues",null,null,[new s("Lgnum",i.EQ,e)]).requestContexts(0,Infinity).then(function(e){const t=e.map(function(e){return e.getObject()});n.setProperty("/queues",t);console.log("Queues loaded:",t.length)}).catch(function(e){console.error("Failed to load queues:",e);o.show("Failed to load queues. Using empty list.");n.setProperty("/queues",[])})},_loadUoms:function(){const e=this.getView().getModel("ViewModel");const t=this.getOwnerComponent().getModel();t.bindList("/UnitsOfMeasure").requestContexts(0,Infinity).then(function(t){const o=t.map(function(e){return e.getObject()});e.setProperty("/uoms",o);console.log("UOMs loaded:",o.length)}).catch(function(t){console.error("Failed to load UOMs:",t);o.show("Failed to load UOMs from backend. Using default list.");e.setProperty("/uoms",aFallbackUoms)})},_loadWarehouseStandards:function(e){const t=this.getOwnerComponent().getModel();const n=this.getView().getModel("ViewModel");const a=this;t.bindList("/WarehouseStandards",null,[new r("Queue",false)],[new s("WhseNo",i.EQ,e)]).requestContexts(0,Infinity).then(function(t){const s=t.map(function(e,t){const o=e.getObject();return{SNo:t+1,ID:o.ID,Queue:o.Queue,Value:o.Value,Uom:o.Uom,WhseNo:o.WhseNo,createdAt:o.createdAt,__state:"UNCHANGED"}});n.setProperty("/rows",s);n.setProperty("/originalRows",JSON.parse(JSON.stringify(s)));if(s.length===0){n.setProperty("/editMode",true);n.setProperty("/toggleeditbtn",false);n.setProperty("/canAddRow",true);o.show("No existing records found for warehouse "+e)}else{n.setProperty("/editMode",false);n.setProperty("/toggleeditbtn",true);n.setProperty("/canAddRow",false)}}).catch(function(e){console.error("Failed to load warehouse standards",e);o.show("Failed to load data. You can add new rows.");n.setProperty("/rows",[]);n.setProperty("/originalRows",[]);n.setProperty("/editMode",true);n.setProperty("/toggleeditbtn",false)})},onEditButtonPress:function(){const e=this.getView().getModel("ViewModel");e.setProperty("/editMode",true);e.setProperty("/toggleeditbtn",false);e.setProperty("/canAddRow",true)},onAddRow:function(){const e=this.getView().getModel("ViewModel");const t=e.getProperty("/rows");t.push({SNo:t.length+1,WhseNo:this._currentWarehouse,Queue:"",Value:0,Uom:"",__state:"NEW"});e.setProperty("/rows",t);e.setProperty("/editMode",true);e.setProperty("/toggleeditbtn",false)},onDeleteRow:function(e){const t=this.getView().getModel("ViewModel");const o=t.getProperty("/rows");const n=parseInt(e.getParameter("listItem").getBindingContext("ViewModel").getPath().split("/")[2],10);const s=o[n];if(s.__state==="UNCHANGED"&&s.ID){const e=t.getProperty("/deletedRows")||[];e.push(s);t.setProperty("/deletedRows",e)}o.splice(n,1);o.forEach(function(e,t){e.SNo=t+1});t.setProperty("/rows",o)},onSaveButtonPress:function(){const e=this.getView().getModel("ViewModel");const t=this.getOwnerComponent().getModel();const s=e.getProperty("/rows");const i=e.getProperty("/originalRows");const r=e.getProperty("/deletedRows")||[];const a=e.getProperty("/queues");const u=e.getProperty("/uoms");const l=this;for(var c=0;c<s.length;c++){if(!s[c].Queue||!s[c].Uom||s[c].Value===""||s[c].Value===null||s[c].Value===undefined){n.error("Please fill all fields in row "+(c+1));return}const e=a.some(function(e){return e.Queue===s[c].Queue});if(!e){n.error("Queue '"+s[c].Queue+"' in row "+(c+1)+" is not available for warehouse "+l._currentWarehouse+". Please select a valid queue from the list.");return}const t=u.some(function(e){return e.Msehi===s[c].Uom});if(!t){n.error("UOM '"+s[c].Uom+"' in row "+(c+1)+" is not valid. Please select a valid UOM from the list.");return}}const d=s.some(function(e){return e.__state==="NEW"});const h=r.length>0;const g=s.some(function(e){if(e.__state==="UNCHANGED"){const t=i.find(function(t){return t.ID===e.ID});if(t){return e.Value!==t.Value||e.Uom!==t.Uom||e.Queue!==t.Queue}}return false});if(!d&&!h&&!g){o.show("No changes detected");e.setProperty("/editMode",false);e.setProperty("/toggleeditbtn",true);e.setProperty("/canAddRow",false);return}const m=[];r.forEach(function(e){if(e.ID){const o="/WarehouseStandards(ID="+e.ID+",WhseNo='"+e.WhseNo+"',Queue='"+encodeURIComponent(e.Queue)+"')";const n=t.bindContext(o).getBoundContext();const s=n.requestObject().then(function(){return n.delete("$auto")});m.push(s)}});s.forEach(function(e){if(e.__state==="NEW"){const o=t.bindList("/WarehouseStandards");const n=o.create({WhseNo:e.WhseNo,Queue:e.Queue,Value:Number(e.Value)||0,Uom:e.Uom});m.push(n.created())}});s.forEach(function(e){if(e.__state==="UNCHANGED"){const o=i.find(function(t){return t.ID===e.ID});if(o&&(e.Value!==o.Value||e.Uom!==o.Uom)){const n="/WarehouseStandards(ID="+e.ID+",WhseNo='"+e.WhseNo+"',Queue='"+encodeURIComponent(o.Queue)+"')";const s=t.bindContext(n).getBoundContext();const i=s.requestObject().then(function(){s.setProperty("Value",Number(e.Value)||0);s.setProperty("Uom",e.Uom);return t.submitBatch("$auto")});m.push(i)}}});Promise.all(m).then(function(){return t.submitBatch("$auto")}).then(function(){o.show("âœ…Saved successfully");e.setProperty("/editMode",false);e.setProperty("/toggleeditbtn",true);e.setProperty("/canAddRow",false);e.setProperty("/deletedRows",[]);l._loadWarehouseStandards(l._currentWarehouse)}).catch(function(e){console.error("Save error:",e);n.error("Save failed: "+(e.message||"Unknown error"))})},onQueueValueHelp:function(e){const n=this.getView().getModel("ViewModel");const s=n.getProperty("/queues");const i=e.getSource();if(s.length===0){o.show("No queues available. Please type manually.");return}this._oQueueInput=i;if(!this._oQueueDialog){const e=new sap.m.Table({mode:"SingleSelectMaster",growing:true,growingThreshold:20,columns:[new sap.m.Column({header:new sap.m.Text({text:"Queue"})}),new sap.m.Column({header:new sap.m.Text({text:"Description"})})],items:{path:"/",template:new sap.m.ColumnListItem({type:"Active",cells:[new sap.m.Text({text:"{Queue}"}),new sap.m.Text({text:"{Text}"})]})}});const o=new sap.m.SearchField({width:"100%",placeholder:"Search Queue...",search:this.onQueueVHSearch.bind(this),liveChange:this.onQueueVHSearch.bind(this)});this._oQueueDialog=new sap.m.Dialog({title:"Select Queue",contentWidth:"600px",contentHeight:"500px",draggable:true,resizable:true,content:[o,e],endButton:new sap.m.Button({text:"Cancel",press:function(){this._oQueueDialog.close()}.bind(this)})});this._oQueueDialog.setModel(new t(s));this.getView().addDependent(this._oQueueDialog);this._oQueueTable=e}else{this._oQueueDialog.getModel().setData(s)}this._oQueueTable.getBinding("items").filter([]);this._oQueueTable.removeSelections(true);this._oQueueTable.detachSelectionChange(this.onQueueRowSelect,this);this._oQueueTable.attachSelectionChange(this.onQueueRowSelect,this);this._oQueueDialog.open()},onQueueRowSelect:function(e){const t=e.getParameter("listItem");if(!t){return}const n=t.getBindingContext();const s=n.getObject();const i=s.Queue;const r=this._oQueueInput.getBindingContext("ViewModel");const a=this.getView().getModel("ViewModel");const u=a.getProperty("/rows");const l=u.some(e=>e.Queue===i&&e!==r.getObject());if(l){o.show("This queue is already added");t.setSelected(false);return}a.setProperty(r.getPath()+"/Queue",i);this._oQueueDialog.close()},onQueueVHSearch:function(e){const t=e.getParameter("value")||e.getParameter("newValue")||"";const o=[];if(t){o.push(new s({filters:[new s("Queue",i.Contains,t),new s("Text",i.Contains,t)],and:false}))}this._oQueueTable.getBinding("items").filter(o)},onUomValueHelp:function(e){const o=this.getView().getModel("ViewModel");const n=o.getProperty("/uoms");const s=e.getSource();const i=this;this._oUomInput=s;if(!this._oUomDialog){const e=new sap.m.Table({mode:"SingleSelectMaster",growing:true,growingThreshold:20,columns:[new sap.m.Column({header:new sap.m.Text({text:"UOM"})}),new sap.m.Column({header:new sap.m.Text({text:"Description"})})],items:{path:"/",template:new sap.m.ColumnListItem({type:"Active",cells:[new sap.m.Text({text:"{Msehi}"}),new sap.m.Text({text:"{MSEHL}"})]})}});const o=new sap.m.SearchField({width:"100%",placeholder:"Search UOM...",search:this.onUomVHSearch.bind(this),liveChange:this.onUomVHSearch.bind(this)});this._oUomDialog=new sap.m.Dialog({title:"Select UOM",contentWidth:"600px",contentHeight:"500px",draggable:true,resizable:true,content:[o,e],endButton:new sap.m.Button({text:"Cancel",press:function(){this._oUomDialog.close()}.bind(this)})});this._oUomDialog.setModel(new t(n));this.getView().addDependent(this._oUomDialog);this._oUomTable=e}else{this._oUomDialog.getModel().setData(n)}this._oUomTable.getBinding("items").filter([]);this._oUomTable.removeSelections(true);this._oUomTable.detachSelectionChange(this.onUomRowSelect,this);this._oUomTable.attachSelectionChange(this.onUomRowSelect,this);this._oUomDialog.open()},onUomRowSelect:function(e){const t=e.getParameter("listItem");if(!t){return}const o=t.getBindingContext();const n=o.getObject();const s=n.Msehi;const i=this._oUomInput.getBindingContext("ViewModel");const r=this.getView().getModel("ViewModel");r.setProperty(i.getPath()+"/Uom",s);this._oUomDialog.close()},onUomVHSearch:function(e){const t=e.getParameter("value")||e.getParameter("newValue")||"";const o=[];if(t){o.push(new s({filters:[new s("Msehi",i.Contains,t),new s("MSEHL",i.Contains,t)],and:false}))}this._oUomTable.getBinding("items").filter(o)}})});
//# sourceMappingURL=Main.controller.js.map