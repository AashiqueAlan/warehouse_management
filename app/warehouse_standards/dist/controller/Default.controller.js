sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/VariantItem","sap/m/MessageBox"],(e,t,o,s,a)=>{"use strict";return e.extend("warehousestandards.controller.Default",{onInit:function(){const e=new t({warehouses:[],selectedWarehouse:null,warehouseCount:0,userId:"",roles:[],allowedWarehouses:[],isGlobalAdmin:false});this.getView().setModel(e,"view");this._loadWarehouses();this._oVM=this.byId("variantManagement");this._loadSavedVariants();this._applyDefaultVariant();this._loadUserContext()},_loadSavedVariants:function(){const e=localStorage.getItem("warehouseVariants");if(e){try{const t=JSON.parse(e);t.forEach(e=>{const t=new s({key:e.key,title:e.title,author:e.author||"User",favorite:true,visible:true,executeOnSelect:false,rename:true,changeable:true,remove:true});this._oVM.addItem(t)})}catch(e){console.error("Failed to parse variants",e)}}},_applyDefaultVariant:function(){const e=localStorage.getItem("defaultWarehouseVariant");if(e){this._oVM.setDefaultKey(e);this._oVM.setSelectedKey(e);this._applyVariant(e)}},_applyVariant:function(e){if(e==="standard"){this.getView().getModel("view").setProperty("/selectedWarehouse",null);return}const t=localStorage.getItem("warehouseVariants");if(t){try{const s=JSON.parse(t);const a=s.find(t=>t.key===e);if(a&&a.warehouse){this.getView().getModel("view").setProperty("/selectedWarehouse",a.warehouse);this.byId("warehouseInput")?.setSelectedKey(a.warehouse);o.show("Variant '"+a.title+"' applied")}}catch(e){console.error("Failed to apply variant",e)}}},_saveVariantsToStorage:function(){const e=this._oVM.getItems();const t=[];e.forEach(e=>{const o=e.getKey();if(o==="standard"){return}const s=localStorage.getItem("warehouseVariants");let a=null;if(s){try{const e=JSON.parse(s);const t=e.find(e=>e.key===o);if(t){a=t.warehouse}}catch(e){console.error("Error parsing stored variants",e)}}t.push({key:o,title:e.getTitle(),author:e.getAuthor(),warehouse:a})});localStorage.setItem("warehouseVariants",JSON.stringify(t))},_checkCurrentVariant:function(){const e=this._oVM.getSelectedKey();const t=this._oVM.getItemByKey(e);if(!t){const e=this._oVM.getStandardVariantKey();if(e){this._oVM.setSelectedKey(e)}}},_updateItems:function(e){if(e.deleted){e.deleted.forEach(e=>{const t=this._oVM.getItemByKey(e);if(t){this._oVM.removeItem(t);t.destroy()}})}if(e.renamed){e.renamed.forEach(e=>{const t=this._oVM.getItemByKey(e.key);if(t){t.setTitle(e.name)}})}if(e.hasOwnProperty("def")){this._oVM.setDefaultKey(e.def);localStorage.setItem("defaultWarehouseVariant",e.def)}this._checkCurrentVariant()},_createNewItem:function(e){const t="variant_"+Date.now();const a=this.getView().getModel("view").getProperty("/selectedWarehouse");if(!a){o.show("Please select a warehouse before saving variant");return}const r=new s({key:t,title:e.name,executeOnSelect:false,author:"User",favorite:true,changeable:true,remove:true,rename:true});if(e.def){this._oVM.setDefaultKey(t);localStorage.setItem("defaultWarehouseVariant",t)}this._oVM.addItem(r);const n=localStorage.getItem("warehouseVariants");let i=[];if(n){try{i=JSON.parse(n)}catch(e){console.error("Failed to parse variants",e)}}i.push({key:t,title:e.name,author:"User",warehouse:a});localStorage.setItem("warehouseVariants",JSON.stringify(i));o.show("Variant '"+e.name+"' saved successfully");this._oVM.setModified(false)},onVariantSelect:function(e){const t=e.getParameter("key");this._applyVariant(t);this._oVM.setModified(false)},onVariantSave:function(e){const t=e.getParameters();if(t.overwrite){const e=this._oVM.getItemByKey(t.key);const s=this.getView().getModel("view").getProperty("/selectedWarehouse");if(!s){o.show("Please select a warehouse before saving variant");return}const a=localStorage.getItem("warehouseVariants");let r=[];if(a){try{r=JSON.parse(a)}catch(e){console.error("Failed to parse variants",e)}}const n=r.find(e=>e.key===t.key);if(n){n.warehouse=s;n.title=t.name}localStorage.setItem("warehouseVariants",JSON.stringify(r));if(t.def){this._oVM.setDefaultKey(t.key);localStorage.setItem("defaultWarehouseVariant",t.key)}o.show("Variant '"+e.getTitle()+"' updated");this._oVM.setModified(false)}else{this._createNewItem(t)}},onVariantManage:function(e){const t=e.getParameters();this._updateItems(t);this._saveVariantsToStorage();o.show("Variants updated successfully")},_loadWarehouses:function(){const e=this.getOwnerComponent().getModel();const t=this.getView().getModel("view");const s=e.bindList("/Warehouses");s.requestContexts(0,Infinity).then(function(e){const o=e.map(e=>e.getObject());t.setProperty("/warehouses",o);t.setProperty("/warehouseCount",o.length)}).catch(function(e){console.error("Failed to load Warehouses",e);o.show("Failed to load warehouses")})},onWarehouseSelected:function(e){const t=e.getParameter("selectedItem");this.getView().getModel("view").setProperty("/selectedWarehouse",t?t.getKey():null);this._oVM.setModified(true)},onContinue:function(){const e=this.getView().getModel("view");const t=this.getView().getModel("view").getProperty("/selectedWarehouse");const s=e.getProperty("/allowedWarehouses")||[];const r=s.includes("ALL");console.log("aAllowed",s);console.log("bGlobal",r);if(!r&&!s.includes(t)){a.error(`You are not authorized to access warehouse ${t}`);return}if(!t){o.show("Please select a warehouse");return}sessionStorage.setItem("selectedWarehouse",t);this.getOwnerComponent().getRouter().navTo("Main",{lgnum:t})},_loadUserContext:function(){const e=this.getOwnerComponent().getModel();const t=this.getView().getModel("view");return new Promise((o,s)=>{const a=e.bindContext("/getUserContext(...)");a.execute().then(()=>{const e=a.getBoundContext().getObject();console.log("User Context",e);t.setProperty("/userId",e.id);t.setProperty("/roles",e.roles||[]);t.setProperty("/allowedWarehouses",e.allowedWarehouses||[]);t.setProperty("/isGlobalAdmin",(e.allowedWarehouses||[]).includes("ALL"));return e}).catch(e=>{s(e)})})}})});
//# sourceMappingURL=Default.controller.js.map